<span id="create-table-button" title="create table"> <img
	class="buttonimage" height="16px"
	src=" data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABhWlDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw1AUhU9bS4tUHCwo4hCwOlkQFXHUKhShQqgVWnUweekfNGlIUlwcBdeCgz+LVQcXZ10dXAVB8AfE1cVJ0UVKvC8ptIjxwuN9nHfP4b37AH+jwlSzaxxQNctIJxNCNrcqhF7hQxD9GEZYYqY+J4opeNbXPXVT3cV5lnffn9Wj5E0G+ATiWaYbFvEG8fSmpXPeJ46ykqQQnxOPGXRB4keuyy6/cS467OeZUSOTnieOEgvFDpY7mJUMlXiKOKaoGuX7sy4rnLc4q5Uaa92TvzCS11aWuU5rCEksYgkiBMiooYwKLMRp10gxkabzhId/0PGL5JLJVQYjxwKqUCE5fvA/+D1bszA54SZFEkDwxbY/RoDQLtCs2/b3sW03T4DAM3Cltf3VBjDzSXq9rcWOgN5t4OK6rcl7wOUOMPCkS4bkSAFa/kIBeD+jb8oBfbdA95o7t9Y5Th+ADM0qdQMcHAKjRcpe93h3uHNu//a05vcDJaRyiKln68MAAAAGYktHRAAAAAAAAPlDu38AAAAJcEhZcwAALiMAAC4jAXilP3YAAAAHdElNRQfnAQUXKxMmjFFaAAAAGXRFWHRDb21tZW50AENyZWF0ZWQgd2l0aCBHSU1QV4EOFwAAAQdJREFUOMvF008rRFEYx/GPaRDKLO6tiT1lNyXZykZ5B96ItZX3MK/AzkaRQlYSI2lsLSUaUlJqjGPzTN0m/6ZZeDbne+4559dzv51DVJY0siRlybw+qmTAGsqSS1SRYxgttNOb7acxm7+cfy7H4anCxxw6t5YjMGEVe7G+gv3Y15Ql1SyZzpKrcLAycaxWWlMvhO4WeCfGeWyUH4fch8R2LLRelzz81UG5Cx8vtt5vGKm560tigadxgiZGMRucsIiz2LeAc1RwpCeg/gX/6GDge9AbkGLsFNg33PnKwSmuw8FMcIr/bhRav8AkDv7fQblnnkdyXuBOtNt9pZXguV4H41jvs4HDT7LtSltRutR2AAAAAElFTkSuQmCC" />
</span>
<span> <select id=select_text_editor style="width: 100px;">
		<option value="ace/theme/ambiance">ambiance</option>
		<option value="ace/theme/chaos">chaos</option>
		<option value="ace/theme/chrome">chrome</option>
		<option value="ace/theme/cloud9_day">cloud9 day</option>
		<option value="ace/theme/cloud9_night">cloud9 night</option>
		<option value="ace/theme/cloud9_night_low_color">cloud9 night
			low color</option>
		<option value="ace/theme/clouds">clouds</option>
		<option value="ace/theme/clouds_midnight">clouds midnight</option>
		<option value="ace/theme/cobalt">cobalt</option>
		<option value="ace/theme/crimson_editor">crimson editor</option>
		<option value="ace/theme/dawn">dawn</option>
		<option value="ace/theme/dracula">dracula</option>
		<option value="ace/theme/dreamweaver">dreamweaver</option>
		<option value="ace/theme/eclipse">eclipse</option>
		<option value="ace/theme/github">github</option>
		<option value="ace/theme/gob">gob</option>
		<option value="ace/theme/gruvbox">gruvbox</option>
		<option value="ace/theme/gruvbox_dark_hard">gruvbox dark hard</option>
		<option value="ace/theme/gruvbox_light_hard">gruvbox light
			hard</option>
		<option value="ace/theme/idle_fingers">idle fingers</option>
		<option value="ace/theme/iplastic">iplastic</option>
		<option value="ace/theme/katzenmilch">katzenmilch</option>
		<option value="ace/theme/kr_theme">kr theme</option>
		<option value="ace/theme/kuroir">kuroir</option>
		<option value="ace/theme/merbivore">merbivore</option>
		<option value="ace/theme/merbivore_soft">merbivore soft</option>
		<option value="ace/theme/mono_industrial">mono industrial</option>
		<option value="ace/theme/monokai">monokai</option>
		<option value="ace/theme/nord_dark">nord dark</option>
		<option value="ace/theme/one_dark">one dark</option>
		<option value="ace/theme/pastel_on_dark">pastel on dark</option>
		<option value="ace/theme/solarized_light">solarized light</option>
		<option value="ace/theme/solarized_dark">solarized dark</option>
		<option value="ace/theme/sqlserver">sqlserver</option>
		<option value="ace/theme/terminal">terminal</option>
		<option value="ace/theme/textmate">textmate</option>
		<option value="ace/theme/tomorrow">tomorrow</option>
		<option value="ace/theme/tomorrow_night_blue">tomorrow night
			blue</option>
		<option value="ace/theme/tomorrow_night_bright">tomorrow
			night bright</option>
		<option value="ace/theme/tomorrow_night_eighties">tomorrow
			night eighties</option>
		<option value="ace/theme/tomorrow_night">tomorrow night</option>
		<option value="ace/theme/twilight">twilight</option>
		<option value="ace/theme/vibrant_ink">vibrant ink</option>
		<option value="ace/theme/xcode">xcode</option>
</select>
</span>
<span>
	<select id=select_font_size style="width:50px;">
		<option value='5.5'>5.5</option>
<option value='6.0'>6.0</option>
<option value='6.5'>6.5</option>
<option value='7.0'>7.0</option>
<option value='7.5'>7.5</option>
<option value='8.0'>8.0</option>
<option value='8.5'>8.5</option>
<option value='9.0'>9.0</option>
<option value='9.5'>9.5</option>
<option value='10'>10</option>
<option value='11'>11</option>
<option value='12'>12</option>
<option value='13'>13</option>
<option value='14'>14</option>
<option value='15'>15</option>
<option value='16'>16</option>
<option value='17'>17</option>
<option value='18'>18</option>
<option value='19'>19</option>
<option value='20'>20</option>
<option value='24'>24</option>
<option value='28'>28</option>
<option value='32'>32</option>

	</select>
</span>
<div id="create-table-div">
	<div style="padding: 3px;">
		Table name <input id="createTableName" name="tableName">
		<button id="createTable">Create</button>
		<button id="add-row">Add Row</button>
	</div>
	<div style="max-height: 400px; overflow: auto">
		<table class="flattable">
			<thead>
				<tr class="create-table-header-class">
					<td title="column name">Name</td>
					<td title="column type">Type</td>
					<td title="default value">Def.</td>
					<td title="is null">null</td>
					<td title="is primary key">pri.</td>
					<td title="is unique key">uni.</td>
					<td title="auto increment">Inc</td>
					<td title="delete"></td>
				</tr>
			</thead>
			<tbody id="new-tbl-columns"></tbody>
		</table>
	</div>
</div>
<script>
	w.popup = new PopUpWindow("#create-table-div").caption("Create Table");
	w.h2columns = {
		INT : {
			hasCustVal : false,
			def : "null",
			allowPri : true,
			allowAuto : true,
			allowUnique : true
		},
		VARCHAR : {
			hasCustVal : true,
			def : "null",
			allowPri : false,
			allowAuto : false,
			allowUnique : true
		},
		BIGINT : {
			hasCustVal : false,
			def : "null",
			allowPri : false,
			allowAuto : false,
			allowUnique : true
		},
		BLOB : {
			hasCustVal : false,
			def : "null",
			allowPri : false,
			allowAuto : false,
			allowUnique : false
		},
		TEXT : {
			hasCustVal : false,
			def : "null",
			allowPri : false,
			allowAuto : false,
			allowUnique : true
		},
		ENUM : {
			hasCustVal : true,
			def : "null",
			allowPri : false,
			allowAuto : false,
			allowUnique : false
		}
	}

	$("#add-row").click(function(dbcols) {
		return function() {
			w.addColumn(dbcols)
		}
	}(w.h2columns));

	w.addColumn = function(dbcols) {
		let row = $("#new-tbl-columns").row().Cls("create-table-body-class");
		row.cell().css("width", "130px").mk("input").Cls("columname").size(10);
		let selcell = row.cell().css("width", "113px");
		let sel = selcell.mk("select").Cls("columntype");
		let leninput = selcell.mk("input").size(4).Cls("coldeflen").hide();
		sel.option("", "");
		sel.data("dbcols", dbcols);
		for (index in dbcols) {
			sel.option(index, index);
			//sel.dbcols
		}
		sel.on("change", function(obj, leninput) {
			return function() {
				let row = obj.parent().parent();
				if (obj.val() == "") {
					leninput.val("");
					leninput.hide();
					return;
				}
				let t = obj.data("dbcols")[obj.val()];
				if (t.hasCustVal == true) {
					leninput.show();
				} else {
					leninput.val("");
					leninput.hide();
				}
			}
		}(sel, leninput))
		let celldef = row.cell().css("width", "113px");
		let seldef = celldef.mk("select").Cls("defaultval");
		seldef.option("NULL", "NULL");
		seldef.option("EMPTY", "EMPTY");
		seldef.option("VALUE", "VALUE");
		let definp = celldef.mk("input").hide().size(3);
		seldef.on("change", function(celldef) {
			return function() {
				if(seldef.val() == "VALUE") {
					definp.show();
				} else {
					definp.hide();
				}
			}
		}(celldef))

		row.Cell().mk("input").Cls("null").Type("checkbox");
		row.Cell().mk("input").Cls("primary").Type("checkbox").on("click", function() {
			if(!this.Checked()) return;
			let parent = this.Parent().Parent();
			let duplicate = false;
			parent.Parent().each("tr", v => {
				if(parent.index() != v.index() && v.$(".primary").checked()) duplicate = true;
			});
			if(duplicate) {
				this.check(true);
				alert("one table can have only one primary key");
			}
		});
		row.cell().mk("input").Cls("unique").type("checkbox");
		row.cell().mk("input").Cls("autoinc").type("checkbox").on("click", function() {
			if(!this.Checked()) return;
			if(!this.Parent().Parent().$(".primary").Checked()) {
				alert("To enable auto increment, primary key must have to be selected");
				this.Check(false);
			}
		});

		row.cell().mk("img").src(deleteButton).css("cursor", "pointer").on("click", function() {
			let row = this.Parent().Parent();
			if(row.parent().Length() == 1) return;
				row.parent().rm(row);
		});
	}

	$("#create-table-button").click(function() {
		$("#new-tbl-columns").html("");
		w.addColumn(w.h2columns);
		w.popup.show();
	})

	w.validateAndProcessColName = function(h) {
		let colName = h.at(0).$("input");
		let def = "";
		if(colName.val().trim() == "") {
			colName.css("background", "yellow");
			return { failed: true, text: "Column Name cannot be empty" };
		} else {
			colName.css("background", "white");
			return { failed: false, text: "`" + colName.val().trim() + "`" };
		}
	}

	// right now only caring for integer, enum or double is not considered
	w.validateAndProcessLength = function(h) {
		let definp = h.at(1).$("input");
		let sel = h.at(1).$("select")
		let colType = sel.val();
		let dbcols = sel.data("dbcols");
		let length = definp.val().trim();
		if(dbcols[colType].hasCustVal && length == "") {
			definp.css("background", "yellow");
			return { failed: true, text: "Must have to input definition or length"};
		} else if(!dbcols[colType].hasCustVal) {
			definp.css("background", "white");
			return {failed: false, text: "(" + definp.val() + ")"};
		}

		definp.css("background", "white");
		return {failed: false, text: "(" + definp.val().trim() +")"}
	}

	w.validateAndProcessColeType = function(h) {
		let colType = h.at(1).$("select");
		if(colType.val().trim() == "") {
			colType.css("background", "yellow");
			return { failed: true, text: "Must have to select a column type" };
		} else {
			colType.css("background", "white");
			let r = w.validateAndProcessLength(h);
			if(r.failed) return r;
			return { failed: false, text: colType.val().trim() + r.text };
		}
	}

	w.validateAndProcessDefaultValue = function(h) {
		let defType = h.at(2).$("select");
		let defValue = h.at(2).$("input")
		if(defType.val().trim() == "NULL") {
			return { failed: false, text: "NULL" };
		} else if(defType.val().trim() == "EMPTY") {
			return { failed: false, text: "''" };
		}
		if(defValue.val().trim() == '') {
			return { failed: true, text: "Default value should not be empty" };
		}
		return { failed: false, text: "DEFAULT " + defValue.val() };
	}

	$("#createTable").click(function() {
		if($("#createTableName").val().trim() == "") {
			alert("Table name cannot be empty");
			return;
		}
		let failedMessage = "";
		let query = "CREATE TABLE " + $("#createTableName").val() + "(\n"
		let failed = false;
		let cols = [];
		$("#new-tbl-columns").each(h => {
			let colDef;
			let r = w.validateAndProcessColName(h);
			if(r.failed) {
				failed = true;
				failedMessage += r.text + "\n";
			} else {
				colDef = r.text;
			}

			r = w.validateAndProcessColeType(h);
			if(r.failed) {
				failed = true;
				failedMessage += r.text + "\n";
			} else {
				colDef = colDef + " " + r.text;
			}

			r = w.validateAndProcessDefaultValue(h);
			if(r.failed) {
				failed = true;
				failedMessage += r.text + "\n";
			} else {
				colDef = colDef + " " + r.text;
			}

			if(!failed) cols.push(colDef);
		})

		if(failed){
			alert(failedMessage);
		} else if(cols.length>0)  {
			query += cols.join(",\n") + "\n)\n;";
			w.sqlText(query);
			w.popup.close();
		}
	})

$("#select_text_editor").on("change", function() {
	$("#textEditor").contentWindow.editor.setTheme(this.val());
	let l = w.getSQLEditorConf();
	l.theme = this.val();
	w.getSQLEditorConf(l);
})

$("#select_font_size").on("change", function() {
	console.log(this.val());
	$("#textEditor").contentWindow.editor.setFontSize(this.val().toNumber());
	let l = w.getSQLEditorConf();
	l.fontSize = this.val();
	w.getSQLEditorConf(l);
})
</script>
