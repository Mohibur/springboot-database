<span id="execute" title="execute"> <img class="buttonimage"
	height="16px"
	src=" data:image/jpeg;base64,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" />
</span>

<script>
	function getTableName(query) {
		query = query.trim().toLowerCase().replaceAll('\n', ' ').replaceAll('\t', ' ');
		if(!new RegExp(/^select /).test(query)) return "";
		let arr = [...query.matchAll("from +[a-z(_0-9]+")];
		if(arr.length > 1) return "";
		let r = arr[0][0].split(" ");
		return r[r.length - 1].toUpperCase();
	}

	$("#execute").click(function() {
		let v = $("#editor").val().trim();
		let tblname = getTableName(v);
		let ajax =new Ajax().addData("query", v);
		if(v == "") return;
		$("#history").mk("div").title("Add to Editor").cls("query-history").html(v).on("click", function() { $("#editor").val($(this).html()) } )
		;
		if(new RegExp(/^select /).test(v.trim().toLowerCase())) {
			ajax.setPath("[[${path.SELECT_QUERY}]]").onSuccess(function(data) {
				createRow = function(data, row, className) {
					row.addCls(className);
					data.forEach(e => {
						let cell = row.cell();
						cell.html(e);
					})
					if(tblname != "") {
						let buttoncell = row.cell();
						let img = buttoncell.child("img")
						img.src(deleteButton);
						if(row.index() > 0) {
							img.click(function() {
								let proRow = $(this).parent().parent();
								let colCount = proRow.len();
								let cols = new StringJoiner(",\n");
								proRow.parent().row(0).each("td", e=>{
									let i = e.cellIndex();
									if(i!=colCount-1)
										cols.add("`"+e.html()+"` = '"+proRow.cell(i).html()+"'");
								});
								$("#editor").val("DELETE FROM " + tblname + " WHERE \n" + cols.toString());
							});
						}
					}
				}

				let len = data.result.length;
				$("#executionResult").html("");
				setExecutionTime(data.time);
				let table = $("#executionResult").child("table");
				createRow(data.result[0], table.row(), "datatrhead");
				for(let i = 1; i < len; i++) {
					createRow(data.result[i], table.row(), "datatr");
				}
			}).putJson();
		} else {
			ajax.setPath("[[${path.EXECUTE}]]").onSuccess(function(data) {
				$("#executionResult").html(data.result.result);
				updateTableList();
			}).putJson();
		}
	}) 

	function updateTableList() {
		let mergeData = {};
		let parent = $("#tableNameList");
		new Ajax().path("[[${path.TABLE_LIST}]]/").onSuccess(function(data) {
			let dbcols = {};
			if(data.result.length > 0 )parent.$("#notable").hide();
			else parent.$("#notable").show();
			parent.each(".divclass", de => dbcols[de.id()] = 1)
			data.result.forEach(dta => dbcols[dta] = (dbcols[dta] == undefined) ? 2:dbcols[dta] + 2)
			for(index in dbcols) {
				if(dbcols[index] == 1) parent.rm("#" + index);
				else if(dbcols[index] == 2) parent.mk("div").cls("divclass").id(index).html(index);
			}
			
			assingClickToTableDiv();
			hideModifyColumn();
		}).get()
	}
</script>
